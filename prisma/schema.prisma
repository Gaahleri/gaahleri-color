// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

//忽略这个错误，因为我把prisma降到了prisma6
datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// Enum for user roles
enum UserRole {
  USER
  ADMIN
}

// Series model - represents color series/collections from Gaahleri store
model Series {
  id          String   @id @default(cuid())
  name        String   @unique // Series name, e.g., "Professional Series", "Watercolor Series"
  slug        String?  @unique // URL friendly name
  description String?  @db.Text // Description of the series
  colors      Color[]
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@index([name]) // For ordering by name
}

// Color model - individual paint colors from Gaahleri
model Color {
  id          String  @id @default(cuid())
  name        String // Color name, e.g., "Crimson Red"
  hex         String // Hex color code e.g. #FF0000
  rgb         String // RGB values e.g., "255,0,0"
  description String? @db.Text
  buyLink     String? // Link to purchase this specific color
  badge       String? // Badge for the color
  status      String? // Status of the color
  seriesId    String
  series      Series  @relation(fields: [seriesId], references: [id], onDelete: Cascade)

  userRecords       UserRecord[] // Users who saved/liked this color
  recipeIngredients RecipeIngredient[] // This color used in recipes
  purchaseClicks    PurchaseClick[] // Clicks on buy button for this color

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([name, seriesId]) // Unique color name within series
  @@index([seriesId])
  @@index([updatedAt]) // For sorting by most recently updated
  @@index([hex]) // 索引hex值加速颜色查询
}

// User model - synced with Clerk authentication
model User {
  id       String   @id @default(cuid())
  clerkId  String   @unique // Clerk user ID
  email    String   @unique
  name     String?
  imageUrl String?
  country  String? // User's country (optional)
  role     UserRole @default(USER) // USER or ADMIN

  userRecords UserRecord[] // Colors saved by user
  recipes     Recipe[] // Recipes created by user

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([clerkId])
  @@index([role])
}

// UserRecord model - tracks colors saved/liked by users
model UserRecord {
  id String @id @default(cuid())

  userId String
  user   User   @relation(fields: [userId], references: [clerkId], onDelete: Cascade)

  colorId String
  color   Color  @relation(fields: [colorId], references: [id], onDelete: Cascade)

  note       String? @db.Text // Optional user note
  isFavorite Boolean @default(false) // Mark as favorite

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([userId, colorId]) // User can only save a color once
  @@index([userId])
  @@index([colorId])
  @@index([createdAt]) // For querying recent additions
  @@index([userId, isFavorite]) // 复合索引加速收藏查询
}

// Recipe model - stores user's color mixing recipes
model Recipe {
  id          String  @id @default(cuid())
  name        String // Recipe name, e.g., "My Pink"
  description String? @db.Text
  resultHex   String // The resulting mixed color hex
  resultRgb   String // The resulting mixed color rgb

  userId String
  user   User   @relation(fields: [userId], references: [clerkId], onDelete: Cascade)

  ingredients RecipeIngredient[] // Colors and their proportions

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([userId])
  @@index([userId, createdAt]) // 复合索引加速用户配方时间排序查询
}

// RecipeIngredient model - individual colors used in a recipe with proportions
model RecipeIngredient {
  id String @id @default(cuid())

  recipeId String
  recipe   Recipe @relation(fields: [recipeId], references: [id], onDelete: Cascade)

  colorId String
  color   Color  @relation(fields: [colorId], references: [id], onDelete: Cascade)

  parts Int // Number of parts/份数, e.g., 3 parts red, 1 part white

  createdAt DateTime @default(now())

  @@unique([recipeId, colorId]) // Same color can't be added twice to one recipe
  @@index([recipeId])
  @@index([colorId])
}

// PurchaseClick model - tracks user clicks on buy buttons for admin statistics
model PurchaseClick {
  id String @id @default(cuid())

  colorId String
  color   Color  @relation(fields: [colorId], references: [id], onDelete: Cascade)

  userId String? // Optional: Clerk user ID if logged in, null for anonymous
  
  createdAt DateTime @default(now())

  @@index([colorId])
  @@index([userId])
  @@index([createdAt]) // For monthly filtering
}
